name: Deploy debo-backend to EC2

on:
  # push:
  #   branches: [ "main" ]
  workflow_dispatch:

jobs:
  dockerImage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR (registry only)
        run: |
          REGISTRY="$(echo '${{ secrets.DOCKER_REPOSITORY }}' | awk -F/ '{print $1}')"
          aws ecr get-login-password --region "${{ secrets.AWS_REGION }}" \
          | docker login --username AWS --password-stdin "$REGISTRY"

      - name: Build and Push image
        run: |
          docker build -t "${{ secrets.DOCKER_REPOSITORY }}:latest" .
          docker push "${{ secrets.DOCKER_REPOSITORY }}:latest"

  deployDockerImage:
    needs: dockerImage
    runs-on: ubuntu-latest
    steps:
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            DOCKER_REPO='${{ secrets.DOCKER_REPOSITORY }}'
            REGISTRY="$(echo "$DOCKER_REPO" | awk -F/ '{print $1}')"
            CONTAINER_NAME="debo-backend-api"

            PORT_INTERNAL='${{ secrets.PORT }}'
            if [ -z "${PORT_INTERNAL:-}" ]; then PORT_INTERNAL=8000; fi
            PORT_EXTERNAL=8092

            echo "Login a ECR"
            aws ecr get-login-password --region '${{ secrets.AWS_REGION }}' \
            | sudo docker login --username AWS --password-stdin "$REGISTRY"

            echo "Reemplazo de contenedor"
            sudo docker stop "$CONTAINER_NAME" || true
            sudo docker rm "$CONTAINER_NAME" || true
            sudo docker pull "${DOCKER_REPO}:latest"
            sudo docker network create gp_net >/dev/null 2>&1 || true

            sudo docker run -d \
              --name "$CONTAINER_NAME" \
              --restart=always \
              --network gp_net \
              -p ${PORT_EXTERNAL}:${PORT_INTERNAL} \
              -e TOKEN_AUTH='${{ secrets.TOKEN_AUTH }}' \
              -e BASE_URL='${{ secrets.BASE_URL }}' \
              -e CLIENT_ID='${{ secrets.CLIENT_ID }}' \
              -e SQL_DATABASE='${{ secrets.SQL_DATABASE }}' \
              -e SQL_PASSWORD='${{ secrets.SQL_PASSWORD }}' \
              -e SQL_SERVER='${{ secrets.SQL_SERVER }}' \
              -e SQL_USER='${{ secrets.SQL_USER }}' \
              -e PORT=${PORT_INTERNAL} \
              "${DOCKER_REPO}:latest" \
              uvicorn src.main:app --host 0.0.0.0 --port ${PORT_INTERNAL}

            echo "Healthcheck básico"
            sleep 5
            if ! curl -fsS "http://localhost:${PORT_EXTERNAL}/docs" >/dev/null 2>&1; then
              echo "Backend no respondió. Logs:"
              sudo docker logs "$CONTAINER_NAME" || true
              exit 1
            fi

            echo "Instalación/validación ODBC 18 dentro del contenedor"
            # Si ya está, no reinstala
            if sudo docker exec "$CONTAINER_NAME" /bin/sh -lc 'python -c "import pyodbc; import sys; sys.exit(0 if any('\'ODBC Driver 18\'' in d for d in pyodbc.drivers()) else 1)"'; then
              echo "ODBC Driver 18 ya presente"
            else
              # Reintento simple x3
              n=0; max=3
              until [ $n -ge $max ]; do
                if sudo docker exec "$CONTAINER_NAME" /bin/sh -lc '
                  set -eux
                  export DEBIAN_FRONTEND=noninteractive
                  apt-get update
                  apt-get install -y --no-install-recommends curl gnupg gnupg2 ca-certificates apt-transport-https unixodbc unixodbc-dev
                  install -d /etc/apt/keyrings
                  curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg
                  echo "deb [arch=amd64,arm64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/debian/12/prod bookworm main" > /etc/apt/sources.list.d/microsoft-prod.list
                  apt-get update
                  ACCEPT_EULA=Y apt-get install -y --no-install-recommends msodbcsql18 mssql-tools18
                  apt-get install -y --no-install-recommends libgssapi-krb5-2 libkrb5-3 libk5crypto3 libkrb5support0 libcurl4t64 libstdc++6 libgcc-s1 ca-certificates
                  ln -sf /opt/mssql-tools18/bin/sqlcmd /usr/local/bin/sqlcmd || true
                  ln -sf /opt/mssql-tools18/bin/bcp /usr/local/bin/bcp || true
                '; then
                  break
                fi
                n=$((n+1)); echo "Reintento $n/$max en 5s"; sleep 5
              done
              # Verificación final
              sudo docker exec "$CONTAINER_NAME" /bin/sh -lc 'python -c "import pyodbc; print([d for d in pyodbc.drivers() if '\''ODBC Driver 18'\'' in d])"'
            fi

            echo "Dump de últimos logs"
            sudo docker logs --tail=200 "$CONTAINER_NAME" | tail -n 200
